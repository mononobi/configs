#!/bin/bash

clear

# ==========================================
# OpenVPN Bulk Add Script
# ==========================================
# Processes multiple .ovpn files and adds them
# as VPN profiles using openvpn-add script.

# ==========================================
# 1. CONFIGURATION
# ==========================================

DEFAULT_PROFILE_DIR="$HOME/.expressvpn/profiles"
OPENVPN_ADD_SCRIPT="openvpn-add"

# ==========================================
# 2. INPUT PARSING
# ==========================================

usage() {
    echo ""
    echo -e "\033[1;36m============================================================\033[0m"
    echo -e "\033[1;32m      üì¶  EXPRESSVPN BULK PROFILE ADD                \033[0m"
    echo -e "\033[1;36m============================================================\033[0m"
    echo ""
    echo "Usage:"
    echo "  Interactive Mode: $0"
    echo "  With Flags:       $0 [-u <username>] [-p <password>] [-d <directory>]"
    echo ""
    echo -e "\033[1;34mFlags:\033[0m"
    echo "  -u <user>     VPN username"
    echo "  -p <pass>     VPN password"
    echo "  -d <dir>      Directory containing .ovpn files"
    echo ""
    echo -e "\033[1;34mNotes:\033[0m"
    echo "  - If -d is not provided, the script checks for .ovpn files in:"
    echo "    $DEFAULT_PROFILE_DIR"
    echo "  - If no files exist there, you will be prompted to provide a directory."
    echo "  - Profile names will be requested interactively for each .ovpn file."
    echo ""
    exit 1
}

# Initialize variables
VPN_USER=""
VPN_PASS=""
PROFILE_DIR=""

# Parse flag-based arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -u)
            if [[ -z "$2" ]]; then
                echo -e "\033[1;31m‚ùå  Error: -u flag requires a value.\033[0m"
                usage
            fi
            VPN_USER="$2"
            shift 2
            ;;
        -p)
            if [[ -z "$2" ]]; then
                echo -e "\033[1;31m‚ùå  Error: -p flag requires a value.\033[0m"
                usage
            fi
            VPN_PASS="$2"
            shift 2
            ;;
        -d)
            if [[ -z "$2" ]]; then
                echo -e "\033[1;31m‚ùå  Error: -d flag requires a value.\033[0m"
                usage
            fi
            PROFILE_DIR="$2"
            shift 2
            ;;
        -h|--help)
            usage
            ;;
        *)
            echo -e "\033[1;31m‚ùå  Error: Unknown flag '$1'\033[0m"
            usage
            ;;
    esac
done

# ==========================================
# 3. DIRECTORY VALIDATION & SELECTION
# ==========================================

# If -d was not provided, check if default directory has .ovpn files
if [[ -z "$PROFILE_DIR" ]]; then
    if [[ -d "$DEFAULT_PROFILE_DIR" ]] && find "$DEFAULT_PROFILE_DIR" -maxdepth 1 -name "*.ovpn" -type f | grep -q .; then
        PROFILE_DIR="$DEFAULT_PROFILE_DIR"
        echo -e "\033[1;32m‚ÑπÔ∏è  Using default profile directory: $PROFILE_DIR\033[0m"
    else
        # Prompt user for directory
        while [[ -z "$PROFILE_DIR" ]]; do
            read -e -p "Enter directory containing .ovpn files: " INPUT_DIR
            INPUT_DIR="${INPUT_DIR/#\~/$HOME}"
            if [[ -d "$INPUT_DIR" ]]; then
                PROFILE_DIR="$INPUT_DIR"
            else
                echo -e "\033[1;31m‚ùå  Error: Directory not found. Please try again.\033[0m"
            fi
        done
    fi
fi

# Verify directory exists
if [[ ! -d "$PROFILE_DIR" ]]; then
    echo -e "\033[1;31m‚ùå  Error: Directory '$PROFILE_DIR' does not exist.\033[0m"
    exit 1
fi

# Find all .ovpn files in the directory
OVPN_FILES=($(find "$PROFILE_DIR" -maxdepth 1 -name "*.ovpn" -type f | sort))

# Check if any files were found
if [[ ${#OVPN_FILES[@]} -eq 0 ]]; then
    echo -e "\033[1;31m‚ùå  No .ovpn files found in: $PROFILE_DIR\033[0m"
    exit 1
fi

# ==========================================
# 4. USERNAME & PASSWORD INPUT
# ==========================================

# Prompt for username if not provided
if [[ -z "$VPN_USER" ]]; then
    read -p "  üë§  Enter VPN Username: " VPN_USER
fi

# Prompt for password if not provided
if [[ -z "$VPN_PASS" ]]; then
    read -p "  üîë  Enter VPN Password: " VPN_PASS
fi

# Validate inputs
if [[ -z "$VPN_USER" || -z "$VPN_PASS" ]]; then
    echo -e "\033[1;31m‚ùå  Error: VPN username and password are required.\033[0m"
    exit 1
fi

# ==========================================
# 5. FIND AND PROCESS .OVPN FILES
# ==========================================

echo ""
echo -e "\033[1;36m============================================================\033[0m"
echo -e "\033[1;32m      üìä  BULK ADD PROGRESS                           \033[0m"
echo -e "\033[1;36m============================================================\033[0m"
echo ""
echo "Found ${#OVPN_FILES[@]} .ovpn file(s) to process"
echo ""

# Process each file
FILE_COUNT=0
SUCCESS_COUNT=0
FAILED_COUNT=0

# Create "added" subdirectory if it doesn't exist
ADDED_DIR="$PROFILE_DIR/added"
mkdir -p "$ADDED_DIR"

for OVPN_FILE in "${OVPN_FILES[@]}"; do
    FILE_COUNT=$((FILE_COUNT + 1))
    FILE_NAME=$(basename "$OVPN_FILE")

    echo ""
    echo -e " \033[1;34m[$FILE_COUNT/${#OVPN_FILES[@]}] Processing: $FILE_NAME\033[0m"
    echo -e " \033[1;34m---\033[0m"

    # Prompt for profile name
    PROFILE_NAME=""
    while [[ -z "$PROFILE_NAME" ]]; do
        read -p "  üìù  Enter profile name for this file: " PROFILE_NAME
    done

    # Call openvpn-add script with silent mode
    echo "  Adding profile..."
    if "$OPENVPN_ADD_SCRIPT" -s -f "$OVPN_FILE" -n "$PROFILE_NAME" -u "$VPN_USER" -p "$VPN_PASS"; then
        # Move the processed file to the "added" subdirectory
        mv "$OVPN_FILE" "$ADDED_DIR/"
        echo -e "  \033[1;32m‚úì Profile added successfully and file moved to added/ folder\033[0m"
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
    else
        echo -e "  \033[1;31m‚úó Failed to add profile for $FILE_NAME\033[0m"
        FAILED_COUNT=$((FAILED_COUNT + 1))
    fi
done

# ==========================================
# 6. SUMMARY
# ==========================================

echo ""
echo -e "\033[1;36m============================================================\033[0m"
echo -e "\033[1;32m      ‚úì  BULK ADD COMPLETE!                            \033[0m"
echo -e "\033[1;36m============================================================\033[0m"
echo ""
echo -e "  Total files processed:  \033[1;34m$FILE_COUNT\033[0m"
echo -e "  Successfully added:     \033[1;32m$SUCCESS_COUNT\033[0m"
echo -e "  Failed:                 \033[1;31m$FAILED_COUNT\033[0m"
echo -e "  Added files location:   \033[1;33m$ADDED_DIR\033[0m"
echo ""

# Exit with success if at least one profile was added
if [[ $SUCCESS_COUNT -gt 0 ]]; then
    exit 0
else
    exit 1
fi
