#!/bin/bash

# ==========================================
# 1. CONFIGURATION
# ==========================================

# Path to the key file (Must be absolute)
TA_KEY_PATH="$HOME/.expressvpn/keys/ta.key"

# ==========================================
# 2. INPUT PARSING
# ==========================================

usage() {
    echo ""
    echo -e "\033[1;36m============================================================\033[0m"
    echo -e "\033[1;32m      üîê  EXPRESSVPN PROFILE SETUP                  \033[0m"
    echo -e "\033[1;36m============================================================\033[0m"
    echo ""
    echo "Usage:"
    echo "  Interactive Mode: $0"
    echo "  Silent Mode:      $0 -s -f <ovpn_file> -n <profile_name> -u <username> -p <password>"
    echo ""
    echo -e "\033[1;34mFlags:\033[0m"
    echo "  -f <path>     Path to .ovpn file"
    echo "  -n <name>     Profile name"
    echo "  -u <user>     VPN username"
    echo "  -p <pass>     VPN password"
    echo "  -s            Silent mode (requires all other flags)"
    echo ""
    exit 1
}

# Check if the ta.key file exists
if [[ ! -f "$TA_KEY_PATH" ]]; then
    echo ""
    echo -e "\033[1;31m‚ùå  Error: ta.key not found\033[0m"
    echo -e "  Expected location: \033[1;33m$TA_KEY_PATH\033[0m"
    echo "  Please ensure the file exists or edit 'TA_KEY_PATH' inside this script."
    echo ""
    exit 1
fi

MODE="interactive"
OVPN_FILE=""
PROFILE_NAME=""
VPN_USER=""
VPN_PASS=""

# Parse flag-based arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -s)
            MODE="silent"
            shift
            ;;
        -f)
            if [[ -z "$2" ]]; then
                echo -e "\033[1;31m‚ùå  Error: -f flag requires a value.\033[0m"
                usage
            fi
            OVPN_FILE="$2"
            shift 2
            ;;
        -n)
            if [[ -z "$2" ]]; then
                echo -e "\033[1;31m‚ùå  Error: -n flag requires a value.\033[0m"
                usage
            fi
            PROFILE_NAME="$2"
            shift 2
            ;;
        -u)
            if [[ -z "$2" ]]; then
                echo -e "\033[1;31m‚ùå  Error: -u flag requires a value.\033[0m"
                usage
            fi
            VPN_USER="$2"
            shift 2
            ;;
        -p)
            if [[ -z "$2" ]]; then
                echo -e "\033[1;31m‚ùå  Error: -p flag requires a value.\033[0m"
                usage
            fi
            VPN_PASS="$2"
            shift 2
            ;;
        *)
            echo -e "\033[1;31m‚ùå  Error: Unknown flag '$1'\033[0m"
            usage
            ;;
    esac
done

# Validate input based on mode
if [[ "$MODE" == "silent" ]]; then
    if [[ -z "$OVPN_FILE" || -z "$PROFILE_NAME" || -z "$VPN_USER" || -z "$VPN_PASS" ]]; then
        echo -e "\033[1;31m‚ùå  Error: Silent mode requires all flags: -f, -n, -u, -p\033[0m"
        usage
    fi

    if [[ ! -f "$OVPN_FILE" ]]; then
        echo -e "\033[1;31m‚ùå  Error: The OVPN file '$OVPN_FILE' does not exist.\033[0m"
        exit 1
    fi
else
    # Interactive Mode
    clear
    echo ""
    echo -e "\033[1;36m============================================================\033[0m"
    echo -e "\033[1;32m      üîê  EXPRESSVPN PROFILE SETUP                  \033[0m"
    echo -e "\033[1;36m============================================================\033[0m"
    echo ""

    while [[ -z "$OVPN_FILE" ]]; do
        read -e -p "  üìÑ  Enter path to .ovpn file: " INPUT_FILE
        INPUT_FILE="${INPUT_FILE/#\~/$HOME}"
        if [[ -f "$INPUT_FILE" ]]; then
            OVPN_FILE="$INPUT_FILE"
        else
            echo -e "\033[1;31m  ‚ùå  Error: File not found. Please try again.\033[0m"
        fi
    done

    while [[ -z "$PROFILE_NAME" ]]; do
        read -p "  üè∑Ô∏è  Enter Profile Name (e.g., Exp-London): " PROFILE_NAME
    done

    while [[ -z "$VPN_USER" ]]; do
        read -p "  üë§  Enter VPN Username: " VPN_USER
    done

    while [[ -z "$VPN_PASS" ]]; do
        read -p "  üîë  Enter VPN Password: " VPN_PASS
        echo ""
    done
fi

# ==========================================
# 3. EXECUTION
# ==========================================

echo ""
echo -e " \033[1;34m============================================================ \033[0m"
echo -e " \033[1;34m      ‚öôÔ∏è  CONFIGURING PROFILE                      \033[0m"
echo -e " \033[1;34m============================================================ \033[0m"
echo ""
echo -e "  Profile Name:  \033[1;32m$PROFILE_NAME\033[0m"
echo ""

# 1. Import the OVPN file directly
import_out=$(nmcli connection import type openvpn file "$OVPN_FILE" 2>&1)

if [[ $? -ne 0 ]]; then
    echo -e "\033[1;31m‚ùå  Error: Failed to import OVPN file.\033[0m"
    echo "Details: $import_out"
    exit 1
fi

# Extract the temporary connection name
TEMP_NAME=$(basename "$OVPN_FILE" .ovpn)

# 2. Rename the connection
nmcli connection modify "$TEMP_NAME" connection.id "$PROFILE_NAME"

# 3. Clean up the import defaults
# We explicitly remove 'ta' and 'ta-dir' (the internal names) just in case
# the import set them to something weird (like a temp blob).
nmcli connection modify "$PROFILE_NAME" -vpn.data ta
nmcli connection modify "$PROFILE_NAME" -vpn.data ta-dir

# 4. Apply New Flags
# NOTE: We now use 'ta' and 'ta-dir' which map correctly to the GUI fields.
nmcli connection modify "$PROFILE_NAME" \
    connection.permissions "" \
    ipv4.dns-priority -1 \
    +vpn.data "port=1195, \
               comp-lzo=no, \
               tun-mtu=1500, \
               fragment=1300, \
               mssfix=yes, \
               remote-random=yes, \
               cipher=AES-256-GCM, \
               auth=SHA-512, \
               ta=$TA_KEY_PATH, \
               ta-dir=1, \
               username=$VPN_USER, \
               password-flags=0"  # 0 = store for all users | 1 = store for current user

# 5. Inject Password
nmcli connection modify "$PROFILE_NAME" \
    vpn.secrets "password=$VPN_PASS"

echo -e " \033[1;32m‚úì Success! VPN Profile '$PROFILE_NAME' created with correct Key File.\033[0m"
echo ""
