#!/bin/bash

# 1. Clear the screen for a fresh look
clear

# 2. Show the Header
echo -e "\n\033[1;36m============================================================\033[0m"
echo -e "\033[1;32m      ðŸ³ CONDUIT NODE HEALTH SNAPSHOT               \033[0m"
echo -e "\033[1;36m============================================================\033[0m"
echo ""

# 3. Show Docker Stats (Snapshot, No Stream)
# Formatted to be readable
docker stats conduit --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"

# Function to calculate daily connections
calculate_daily_connections() {
  local target_date=$1
  DAILY_CONNECTIONS=$(docker logs conduit 2>/dev/null | grep "$target_date" | grep "Connected: " | awk '{print $8}' | sort -nr | head -n 1)
  if [ -z "$DAILY_CONNECTIONS" ]; then
    DAILY_CONNECTIONS=0
  fi
  echo -e "Peak connections on $target_date:  \033[1;32m$DAILY_CONNECTIONS\033[0m"
}

echo ""
echo -e " \033[1;34m------------------------------------------------------------ \033[0m"
echo -e " \033[1;34m      ðŸ“Š DAILY CONNECTION STATS (Last 14 Days)       \033[0m"
echo -e " \033[1;34m------------------------------------------------------------ \033[0m"
echo ""

# Loop for the last 14 days
for i in $(seq 0 13); do
  TARGET_DATE=$(date -d "$i days ago" +%Y-%m-%d)
  calculate_daily_connections "$TARGET_DATE"
done

echo ""
echo -e " \033[1;33m------------------------------------------------------------ \033[0m"
echo -e " \033[1;33m      ðŸ“œ STARTING LIVE LOG STREAM (Press Ctrl+C to exit)  \033[0m"
echo -e " \033[1;33m------------------------------------------------------------ \033[0m"
echo ""

sleep 6

# 4. Stream the logs
# The -f flag keeps it open. We also tail the last 25 lines to give context immediately.
docker logs -f --tail 25 conduit
